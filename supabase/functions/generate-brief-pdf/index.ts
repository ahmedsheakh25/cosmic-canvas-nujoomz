
import { serve } from "https://deno.land/std@0.168.0/http/server.ts"

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    const { briefId, briefData } = await req.json()

    // Generate PDF content
    const pdfContent = generatePDFContent(briefData)
    
    // In a real implementation, you would use a PDF generation library
    // For now, we'll simulate PDF generation
    const pdfBase64 = btoa(pdfContent)

    // Save PDF URL to database (simulated)
    const pdfUrl = `https://storage.googleapis.com/briefs/${briefId}.pdf`

    return new Response(JSON.stringify({ 
      success: true, 
      pdfUrl,
      pdfContent: pdfBase64 
    }), {
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
    })

  } catch (error) {
    console.error('Error generating PDF:', error)
    return new Response(JSON.stringify({ error: error.message }), {
      status: 500,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
    })
  }
})

function generatePDFContent(briefData: any): string {
  const isArabic = briefData.language === 'ar'
  
  return `
${isArabic ? 'Ù…ÙˆØ¬Ø² Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ÙŠ' : 'Creative Project Brief'}
${isArabic ? 'Ø§Ø³ØªÙˆØ¯ÙŠÙˆ Ø§Ù„ÙØ¶Ø§Ø¡ - Of Space Studio' : 'Of Space Studio'}

${isArabic ? 'Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©:' : 'Service Type:'} ${briefData.service}
${isArabic ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:' : 'Created:'} ${briefData.created_at}

${isArabic ? 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹:' : 'Project Details:'}
${Object.entries(briefData.answers).map(([key, value]) => `${key}: ${value}`).join('\n')}

${isArabic ? 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„:' : 'Client Information:'}
${briefData.client_info.name ? `${isArabic ? 'Ø§Ù„Ø§Ø³Ù…:' : 'Name:'} ${briefData.client_info.name}` : ''}
${briefData.client_info.email ? `${isArabic ? 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:' : 'Email:'} ${briefData.client_info.email}` : ''}
${briefData.client_info.phone ? `${isArabic ? 'Ø§Ù„Ù‡Ø§ØªÙ:' : 'Phone:'} ${briefData.client_info.phone}` : ''}

${isArabic ? 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¬Ø² Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¬Ù…ÙˆØ² ğŸ‘½' : 'Generated by Nujmooz ğŸ‘½'}
  `.trim()
}
